<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SI-ROB | Dashboard Pemantauan Banjir Rob</title>

    <!--
    ============================================================================
    DOCUMENTATION & SETUP INSTRUCTIONS (PFsains 2025 - SI-ROB - TRL 5)
    ============================================================================

    A. ABOUT THIS DASHBOARD:
    This file is a functional pilot demonstration of the "SI-ROB" (Sistem Integrasi
    Pemantauan Banjir Rob) dashboard. It is designed to showcase the core
    functionalities of the proposed solution for the PFsains 2025 competition,
    targeting Technology Readiness Level (TRL) 5: validation in a relevant
    environment.

    B. MOCK DATA USAGE (PENTING):
    All data presented in this dashboard is SIMULATED (MOCK DATA). This includes:
    1.  Real-time water levels from ultrasonic sensors.
    2.  CCTV feeds with virtual tide-staff overlays.
    3.  Weather and tidal prediction API responses.
    4.  Historical flood data for charts.
    The mock data is generated by JavaScript within this file to realistically
    mimic conditions in Riau for TRL 5 validation purposes in a controlled or
    simulated field setting.

    C. HOW TO RUN LOCALLY (USING VISUAL STUDIO CODE):
    This dashboard is designed to be run easily on a local server.

    Prerequisites:
    - Visual Studio Code (VS Code) installed: https://code.visualstudio.com/
    - An internet connection (to load map tiles and libraries).
    - The logo file `si-rob-logo.png` placed in the same folder as this `index.html` file.

    Step-by-step Instructions:
    1.  Save this entire code as a single file named `index.html`.
    2.  Open VS Code.
    3.  Go to the 'Extensions' view (click the icon on the left sidebar or press Ctrl+Shift+X).
    4.  Search for "Live Server" by Ritwick Dey and click "Install".
    5.  Once installed, open the folder containing your `index.html` and `si-rob-logo.png` files in VS Code (File > Open Folder...).
    6.  Right-click on the `index.html` file in the VS Code Explorer panel.
    7.  Select "Open with Live Server" from the context menu.
    8.  Your default web browser will automatically open with the dashboard running,
        typically at an address like http://127.0.0.1:5500/index.html.
        The dashboard is now active and will simulate real-time data updates.

    ============================================================================
    -->

    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Custom Styling & Pertamina Color Palette -->
    <style>
        :root {
            --pertamina-blue: #3C6DB2; /* R:60 G:109 B:178 */
            --pertamina-green: #ADC52D; /* R:173 G:197 B:45 */
            --pertamina-red: #BA313B; /* R:186 G:49 B:59 */
            --pertamina-black: #141410; /* R:20 G:20 B:16 - Used for text */
            --status-aman: #22c55e;
            --status-waspada: #f59e0b;
            --status-bahaya: #ef4444;
            --bg-light: #f1f5f9;
            --card-bg: #ffffff;
            --border-color: #e2e8f0;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-light);
            color: var(--pertamina-black);
        }

        .header {
            background-color: var(--card-bg);
            border-bottom: 4px solid var(--pertamina-blue);
        }

        .btn-primary {
            background-color: var(--pertamina-blue);
            color: white;
            transition: background-color 0.3s;
        }
        .btn-primary:hover {
            background-color: #325c99;
        }

        .leaflet-popup-content-wrapper {
            background-color: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .leaflet-popup-tip {
            background-color: var(--card-bg);
        }
        .leaflet-popup-content {
            margin: 1rem;
            font-size: 14px;
        }
        .popup-title {
            font-weight: 600;
            color: var(--pertamina-blue);
            font-size: 16px;
            margin-bottom: 8px;
        }
        
        /* FIX: Ensure modals appear above the Leaflet map panes */
        #history-modal, #cctv-modal {
            z-index: 2000;
        }

        /* Custom marker pulse animation */
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.5); opacity: 0.5; }
            100% { transform: scale(2); opacity: 0; }
        }
        .pulse {
            animation: pulse 1.5s infinite;
            border-radius: 50%;
            position: absolute;
            width: 24px;
            height: 24px;
            left: 0;
            top: 0;
        }
    </style>
</head>
<body class="flex flex-col h-screen">

    <!-- Header -->
    <header class="header shadow-md p-4 flex justify-between items-center">
        <div class="flex items-center space-x-4">
            <img src="si-rob-logo.png" alt="SI-ROB Logo" class="h-12" onerror="this.onerror=null;this.src='https://placehold.co/150x50/3c6db2/ffffff?text=SI-ROB';">
            <div>
                <h1 class="text-2xl font-bold text-pertamina-blue">SI-ROB</h1>
                <p class="text-sm text-gray-500">Sistem Integrasi Pemantauan Banjir Rob</p>
            </div>
        </div>
        <div class="flex items-center space-x-2 text-sm text-gray-600">
            <i data-lucide="calendar" class="w-4 h-4"></i>
            <span id="datetime"></span>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow flex flex-col lg:flex-row p-4 gap-4 overflow-hidden">
        <!-- Map Section -->
        <div class="lg:w-2/3 w-full h-64 lg:h-full rounded-lg shadow-lg overflow-hidden">
            <div id="map" class="w-full h-full"></div>
        </div>

        <!-- Data Panel Section -->
        <div class="lg:w-1/3 w-full flex flex-col gap-4 overflow-y-auto">
            <!-- General Alert -->
            <div id="general-alert" class="p-4 rounded-lg shadow-lg flex items-center space-x-4 transition-all duration-500">
                <div id="alert-icon-container" class="p-3 rounded-full">
                    <i id="alert-icon" data-lucide="shield" class="w-8 h-8 text-white"></i>
                </div>
                <div>
                    <h3 id="alert-title" class="font-bold text-lg"></h3>
                    <p id="alert-message" class="text-sm"></p>
                </div>
            </div>

            <!-- Weather & Tidal Forecast -->
            <div class="bg-white p-4 rounded-lg shadow-lg">
                <h2 class="text-xl font-bold mb-4 text-pertamina-blue flex items-center"><i data-lucide="cloud-sun" class="w-5 h-5 mr-2"></i>Prediksi Cuaca & Pasang Surut</h2>
                <div class="space-y-3 text-sm">
                    <div class="flex justify-between items-center">
                        <span class="font-semibold flex items-center"><i data-lucide="thermometer" class="w-4 h-4 mr-2 text-gray-500"></i>Suhu</span>
                        <span id="weather-temp" class="font-bold"></span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="font-semibold flex items-center"><i data-lucide="wind" class="w-4 h-4 mr-2 text-gray-500"></i>Angin</span>
                        <span id="weather-wind"></span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="font-semibold flex items-center"><i data-lucide="waves" class="w-4 h-4 mr-2 text-gray-500"></i>Pasang Surut Tertinggi</span>
                        <span id="tidal-high" class="font-bold text-pertamina-blue"></span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="font-semibold flex items-center"><i data-lucide="chevrons-down" class="w-4 h-4 mr-2 text-gray-500"></i>Waktu Pasang</span>
                        <span id="tidal-time"></span>
                    </div>
                    <p class="text-xs text-gray-400 text-center pt-2">*Data prediksi merupakan simulasi untuk pilot TRL 5.</p>
                </div>
            </div>

            <!-- Station List -->
            <div class="bg-white p-4 rounded-lg shadow-lg">
                <h2 class="text-xl font-bold mb-2 text-pertamina-blue flex items-center"><i data-lucide="map-pin" class="w-5 h-5 mr-2"></i>Status Stasiun Pemantauan</h2>
                <div id="station-list" class="space-y-3">
                    <!-- Station data will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </main>

    <!-- Modal for Historical Data -->
    <div id="history-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex justify-center items-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-3xl p-6 relative">
            <button onclick="closeHistoryModal()" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
            <h2 id="history-modal-title" class="text-2xl font-bold mb-4 text-pertamina-blue"></h2>
            <div class="h-80">
                <canvas id="history-chart"></canvas>
            </div>
        </div>
    </div>

    <!-- Modal for CCTV Feed -->
    <div id="cctv-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex justify-center items-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl p-2 relative">
             <button onclick="closeCctvModal()" class="absolute top-2 right-2 text-white bg-black bg-opacity-50 rounded-full p-1 z-20">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
            <h2 id="cctv-modal-title" class="text-lg font-bold text-white bg-black bg-opacity-70 absolute top-2 left-2 p-2 rounded-md"></h2>
            <div class="relative">
                <img src="https://placehold.co/1280x720/607d8b/ffffff?text=Simulasi+Feed+CCTV" class="rounded-md w-full">
                <div id="virtual-tide-staff" class="absolute top-0 right-8 h-full w-16 bg-white bg-opacity-80 flex flex-col-reverse">
                    <!-- Tide staff markers will be added here -->
                </div>
                <div id="water-level-overlay" class="absolute bottom-0 left-0 w-full bg-blue-500 bg-opacity-50 transition-all duration-500"></div>
                 <div id="water-level-text" class="absolute bottom-4 right-28 text-white font-bold text-xl p-2 bg-black bg-opacity-50 rounded"></div>
            </div>
        </div>
    </div>


    <script>
        // ========================================================================
        // SCRIPT LOGIC FOR SI-ROB DASHBOARD
        // ========================================================================

        // --- 1. INITIALIZATION & CONFIGURATION ---
        const stations = [
            { id: 1, name: "Stasiun Dumai Kota", coords: [1.685167, 101.4785], status: "Aman", waterLevel: 0.3 },
            { id: 2, name: "Stasiun Pelabuhan TPI", coords: [1.666111, 101.500667], status: "Aman", waterLevel: 0.4 },
            { id: 3, name: "Stasiun Bagan Besar", coords: [1.691, 101.429694], status: "Aman", waterLevel: 0.2 },
            { id: 4, name: "Stasiun Bengkalis Pusat", coords: [0.53975, 101.447694], status: "Aman", waterLevel: 0.5 }
        ];

        const map = L.map('map').setView([1.67, 101.45], 11);
        const markers = {};
        let historyChartInstance = null;

        // --- 2. MAP SETUP ---
        function setupMap() {
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors | SI-ROB TRL 5 Demo'
            }).addTo(map);

            stations.forEach(station => {
                const marker = L.marker(station.coords, {
                    icon: createMarkerIcon(station.status)
                }).addTo(map);

                marker.on('click', () => showPopup(station.id));
                markers[station.id] = marker;
            });
        }

        function createMarkerIcon(status) {
            const color = getStatusInfo(status).color;
            const html = `
                <div class="relative flex justify-center items-center">
                    <div class="pulse" style="background-color: ${color};"></div>
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="${color}" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-map-pin relative"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>
                </div>`;
            return L.divIcon({
                html: html,
                className: '',
                iconSize: [24, 24],
                iconAnchor: [12, 24]
            });
        }

        function showPopup(stationId) {
            const station = stations.find(s => s.id === stationId);
            const statusInfo = getStatusInfo(station.status);
            const popupContent = `
                <div class="popup-title">${station.name}</div>
                <div><strong>Status:</strong> <span style="color: ${statusInfo.color}; font-weight: bold;">${station.status}</span></div>
                <div><strong>Ketinggian Air:</strong> ${station.waterLevel.toFixed(2)} m</div>
                <div class="mt-3 flex space-x-2">
                    <button onclick="openHistoryModal(${station.id})" class="text-xs px-2 py-1 rounded btn-primary">Lihat Riwayat</button>
                    <button onclick="openCctvModal(${station.id})" class="text-xs px-2 py-1 rounded bg-gray-600 text-white hover:bg-gray-700">Lihat CCTV</button>
                </div>
            `;
            L.popup({ offset: [0, -20] })
                .setLatLng(station.coords)
                .setContent(popupContent)
                .openOn(map);
        }


        // --- 3. UI & DATA UPDATE FUNCTIONS ---
        function updateDateTime() {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' };
            document.getElementById('datetime').textContent = now.toLocaleDateString('id-ID', options) + ' WIB';
        }

        function updateStationList() {
            const listElement = document.getElementById('station-list');
            listElement.innerHTML = '';
            stations.forEach(station => {
                const statusInfo = getStatusInfo(station.status);
                const item = document.createElement('div');
                item.className = 'flex justify-between items-center p-2 rounded-md hover:bg-gray-50 cursor-pointer';
                item.onclick = () => map.setView(station.coords, 14);
                item.innerHTML = `
                    <div>
                        <p class="font-semibold">${station.name}</p>
                        <p class="text-xs text-gray-500">Ketinggian: ${station.waterLevel.toFixed(2)} m</p>
                    </div>
                    <span class="px-2 py-1 text-xs font-bold text-white rounded-full" style="background-color: ${statusInfo.color};">${station.status}</span>
                `;
                listElement.appendChild(item);
            });
        }

        function updateGeneralAlert() {
            const alertCounts = stations.reduce((acc, station) => {
                acc[station.status] = (acc[station.status] || 0) + 1;
                return acc;
            }, {});

            let alertLevel = "Aman";
            if (alertCounts.Bahaya > 0) alertLevel = "Bahaya";
            else if (alertCounts.Waspada > 0) alertLevel = "Waspada";

            const info = getStatusInfo(alertLevel);
            const alertEl = document.getElementById('general-alert');
            const iconContainer = document.getElementById('alert-icon-container');
            
            alertEl.style.backgroundColor = info.bgColor;
            iconContainer.style.backgroundColor = info.color;
            document.getElementById('alert-icon').setAttribute('data-lucide', info.icon);
            document.getElementById('alert-title').textContent = `Status Sistem: ${info.text}`;
            document.getElementById('alert-message').textContent = info.message;
            lucide.createIcons();
        }
        
        function updateWeatherForecast() {
            // Mock API response for weather
            const mockWeather = {
                temp: 31.5,
                wind: "12 km/j Tenggara",
                tidal_high: 1.8,
                tidal_time: "14:30 WIB"
            };
            document.getElementById('weather-temp').textContent = `${mockWeather.temp}°C`;
            document.getElementById('weather-wind').textContent = mockWeather.wind;
            document.getElementById('tidal-high').textContent = `${mockWeather.tidal_high} m`;
            document.getElementById('tidal-time').textContent = mockWeather.tidal_time;
        }

        // --- 4. DATA SIMULATION (MOCK DATA) ---
        function simulateDataChanges() {
            stations.forEach(station => {
                // Simulate water level fluctuation
                const change = (Math.random() - 0.5) * 0.2; // small random change
                station.waterLevel = Math.max(0, Math.min(2.5, station.waterLevel + change));

                // Update status based on water level
                if (station.waterLevel > 1.5) station.status = "Bahaya";
                else if (station.waterLevel > 0.8) station.status = "Waspada";
                else station.status = "Aman";

                // Update marker icon
                markers[station.id].setIcon(createMarkerIcon(station.status));
            });

            // Refresh UI components
            updateStationList();
            updateGeneralAlert();
        }


        // --- 5. MODAL HANDLING ---
        function openHistoryModal(stationId) {
            const station = stations.find(s => s.id === stationId);
            document.getElementById('history-modal-title').textContent = `Riwayat Ketinggian Air: ${station.name}`;
            
            // Mock historical data
            const labels = Array.from({length: 24}, (_, i) => `${String(i).padStart(2, '0')}:00`);
            const data = Array.from({length: 24}, () => Math.random() * 2.0);

            const ctx = document.getElementById('history-chart').getContext('2d');
            if (historyChartInstance) {
                historyChartInstance.destroy();
            }
            historyChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Ketinggian Air (m)',
                        data: data,
                        borderColor: 'var(--pertamina-blue)',
                        backgroundColor: 'rgba(60, 109, 178, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, title: { display: true, text: 'Meter' } } }
                }
            });
            document.getElementById('history-modal').classList.remove('hidden');
        }

        function closeHistoryModal() {
            document.getElementById('history-modal').classList.add('hidden');
        }

        function openCctvModal(stationId) {
            const station = stations.find(s => s.id === stationId);
            document.getElementById('cctv-modal-title').textContent = `CCTV: ${station.name}`;
            
            const waterLevelPercent = (station.waterLevel / 2.5) * 100;
            document.getElementById('water-level-overlay').style.height = `${waterLevelPercent}%`;
            document.getElementById('water-level-text').textContent = `${station.waterLevel.toFixed(2)} m`;
            
            // Create virtual tide staff
            const tideStaff = document.getElementById('virtual-tide-staff');
            tideStaff.innerHTML = '';
            for (let i = 0; i <= 2.5; i += 0.5) {
                const markerEl = document.createElement('div');
                markerEl.className = 'w-full text-right pr-2 text-xs font-mono border-t border-gray-500';
                markerEl.style.flexBasis = '20%'; // 100% / 5 markers
                markerEl.textContent = `${i.toFixed(1)}m`;
                tideStaff.appendChild(markerEl);
            }

            document.getElementById('cctv-modal').classList.remove('hidden');
        }

        function closeCctvModal() {
            document.getElementById('cctv-modal').classList.add('hidden');
        }

        // --- 6. UTILITY FUNCTIONS ---
        function getStatusInfo(status) {
            switch (status) {
                case "Bahaya":
                    return { color: 'var(--status-bahaya)', bgColor: '#fee2e2', icon: 'shield-alert', text: 'BAHAYA', message: 'Beberapa stasiun mendeteksi level air berbahaya. Waspada banjir!' };
                case "Waspada":
                    return { color: 'var(--status-waspada)', bgColor: '#fef3c7', icon: 'shield-check', text: 'WASPADA', message: 'Level air meningkat di beberapa lokasi. Harap berhati-hati.' };
                default: // Aman
                    return { color: 'var(--status-aman)', bgColor: '#dcfce7', icon: 'shield', text: 'AMAN', message: 'Semua stasiun dalam kondisi normal dan terkendali.' };
            }
        }

        // --- 7. APP START ---
        document.addEventListener('DOMContentLoaded', () => {
            setupMap();
            updateDateTime();
            updateStationList();
            updateGeneralAlert();
            updateWeatherForecast();
            lucide.createIcons();

            // Set intervals for updates
            setInterval(updateDateTime, 1000); // Update time every second
            setInterval(simulateDataChanges, 3000); // Simulate data changes every 3 seconds
        });

    </script>
</body>
</html>
